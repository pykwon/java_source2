<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chat Room</title>
<!-- SockJS와 STOMP 라이브러리 읽기용 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    let stompClient = null;

    function connect() {
        // "/ws" 엔드포인트를 통해 WebSocket 연결을 생성한다.
        let socket = new SockJS('/ws');
        // 클라이언트가 WebSocket 연결을 통해 STOMP 프로토콜을 사용할 수 있도록 설정
        stompClient = Stomp.over(socket); 

        // 연결이 성공하면 콜백 함수가 호출된다.
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // "/topic/messages"로 수신된 메시지를 처리한다.
            // 이렇게 구독하는 클라이언트는 서버가 해당 경로에 브로드캐스트한 메시지를 모두 수신할 수 있다. 
            // 예를 들어, 여러 클라이언트가 동시에 접속해 있으면, 한 클라이언트가 메시지를 전송했을 때 
            // 이 메시지는 서버를 통해 다른 모든 클라이언트에게 전달된다.
            stompClient.subscribe('/topic/messages', function (message) {
                showMessage(message.body);
            });
        });
    }

    function sendMessage() {
        // 사용자가 입력한 메시지를 "/app/message"로 전송한다.
        let msgContent = document.querySelector('#message').value;
        // STOMP 클라이언트를 사용하여 서버로 메시지를 전송하는 명령
        // 주로 채팅 메시지, 명령, 데이터 업데이트 요청 등을 서버로 전달하는 데 사용
        // send(메시지의 목적지,메시지 헤더를 지정,메시지의 내용(payload))
        stompClient.send("/app/message", {}, msgContent);
    }

    function showMessage(message) {
        // 수신된 메시지를 페이지에 표시한다.
        let msgElement = document.createElement('li');
        msgElement.textContent = message;
        document.querySelector('#msgArea').appendChild(msgElement);
    }

    // 페이지 로드 시 WebSocket 연결을 설정한다.
    window.onload = function() {
        connect();
    };
</script>
</head>
<body>
<div>
    <input type="text" id="message" placeholder="메시지 입력..."  
    	onkeydown="if (event.keyCode == 13) sendMessage()" />
    <button onclick="sendMessage()">전송</button>
</div>

<ul id="msgArea"></ul>
</body>
</html>
