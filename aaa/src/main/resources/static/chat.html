<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chat Room</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    let stompClient = null;  // STOMP 클라이언트를 저장할 변수를 선언

    function connect() { // WebSocket 연결을 설정하는 함수
        let socket = new SockJS('/ws');  // '/ws' 엔드포인트로 SockJS 연결을 생성
        stompClient = Stomp.over(socket); // SockJS를 통해 STOMP 프로토콜을 사용

        // STOMP 연결을 설정하고, 연결되면 주어진 콜백 함수를 실행
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            // 특정 주제('/topic/public')를 구독하여, 서버에서 메시지를 수신
            stompClient.subscribe('/topic/public', function (message) {
            	// 수신한 메시지를 파싱하고, 화면에 표시
                showMessage(JSON.parse(message.body));
            });
        });
    }

    function sendMessage() { // 메시지를 서버로 전송하는 함수
        let nameInput = document.querySelector('#name');
        let messageContent = document.querySelector('#message').value;
		
        // 이름 입력이 완료되지 않았을 경우, 이름을 서버로 전송하고 입력란을 비활성화
        if (!nameInput.disabled) {
            stompClient.send("/app/chat.addUser", {}, JSON.stringify({sender: nameInput.value, type: 'JOIN'}));
            nameInput.disabled = true;
        }

        // 메시지가 존재하고 STOMP 클라이언트가 연결되어 있으면, 메시지를 서버로 전송
        if (messageContent && stompClient) {
            let chatMessage = {
                sender: nameInput.value, // 메시지를 보낸 사람의 이름을 설정
                content: messageContent,
                type: 'CHAT'     // 메시지의 타입을 'CHAT'으로 설정
            };
            // 서버로 메시지를 전송
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
            document.querySelector('#message').value = '';
        }
    }

    function leaveChat() { // 채팅을 떠날 때 호출되는 함수
        if (stompClient) { // STOMP 클라이언트가 연결되어 있는지 확인
            stompClient.disconnect();  // 연결을 끊음.
        }
        document.querySelector('#name').disabled = false; // 이름 입력란 활성화
        alert("You have left the chat");
    }

    function showMessage(message) { // 수신한 메시지를 화면에 표시하는 함수
    	// 새로운 리스트 항목을 생성
        let messageElement = document.createElement('li');

        // 메시지의 타입에 따라 다른 메시지를 화면에 표시
        if (message.type === 'JOIN') {
        	// 'JOIN' 메시지일 경우, 이벤트 메시지 스타일을 추가
            messageElement.classList.add('event-message');
            // 메시지 내용을 '입장'으로 설정
            message.content = message.sender + '님 입장';
        } else if (message.type === 'LEAVE') {
        	// 'LEAVE' 메시지일 경우, 이벤트 메시지 스타일을 추가
            messageElement.classList.add('event-message');
            // 메시지 내용을 '퇴장'으로 설정
            message.content = message.sender + '님 퇴장';
        } else {
        	// 일반 채팅 메시지일 경우, 채팅 메시지 스타일을 추가
            messageElement.classList.add('chat-message');
            // 사용자 이름을 표시할 요소를 생성
            let usernameElement = document.createElement('strong');
            // 사용자 이름에 'nickname' 스타일을 추가
            usernameElement.classList.add('nickname');
            // 사용자 이름과 콜론을 텍스트로 추가
            let usernameText = document.createTextNode(message.sender + ' : ');
            
            // 사용자 이름 요소에 텍스트를 추가
            usernameElement.appendChild(usernameText);
            // 메시지 항목에 사용자 이름을 추가
            messageElement.appendChild(usernameElement);
        }
		
        // 메시지 내용을 표시할 요소를 생성
        let textElement = document.createElement('span');
        // 메시지 내용을 텍스트로 변환
        let messageText = document.createTextNode(message.content);
        // 텍스트를 요소에 추가
        textElement.appendChild(messageText);
        // 메시지 항목에 텍스트 요소를 추가
        messageElement.appendChild(textElement);
		
        // 메시지 항목을 메시지 영역에 추가
        document.querySelector('#messageArea').appendChild(messageElement);
    }

    window.onload = function() { // 페이지가 로드되면 자동으로 WebSocket 연결을 설정
        connect();
    };

    window.onbeforeunload = function() { // 페이지가 닫히기 전, WebSocket 연결을 종료
        if (stompClient) {
            stompClient.disconnect(); // 페이지를 떠날 때 연결을 종료
        }
    };
</script>
</head>
<body>
<div>
    <input type="text" id="name" placeholder="이름 입력">
    <br/>
    <input type="text" id="message" placeholder="메세지 입력..." onkeydown="if (event.keyCode == 13) sendMessage()">
    <button onclick="sendMessage()">Send</button>
    <button onclick="leaveChat()">Leave</button> <!-- 퇴장 버튼 -->
</div>

<ul id="messageArea"></ul>
</body>
</html>